<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jastipbyceline ¬∑ Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            color: #333;
            font-size: 2.5rem;
        }
        .header p {
            color: #666;
            margin-top: 10px;
        }
        .main-content {
            background: white;
            border-radius: 0 0 20px 20px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .setup-section {
            background: #f0f9ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #7dd3fc;
        }
        .setup-section input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: monospace;
        }
        .setup-section button {
            background: #0e7a9e;
            margin-right: 10px;
        }
        .import-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px dashed #dee2e6;
        }
        .format-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            margin: 15px 0;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-family: monospace;
            margin-bottom: 15px;
            resize: vertical;
        }
        textarea:focus {
            border-color: #667eea;
            outline: none;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .customers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .customer-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #dee2e6;
            position: relative;
        }
        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }
        .customer-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        .customer-phone {
            color: #667eea;
            font-weight: 600;
        }
        .new-customer-badge {
            background: #28a745;
            color: white;
            padding: 3px 10px;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 10px;
            text-transform: uppercase;
        }
        .private-link {
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            word-break: break-all;
            margin: 10px 0;
        }
        .copy-btn {
            background: #28a745;
            width: 100%;
            margin-top: 5px;
        }
        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            color: #666;
            font-size: 0.9rem;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            animation: slideIn 0.3s;
            z-index: 1000;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .status-connected {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üì¶ JASTIPBYCELINE ADMIN</h1>
                <p>üîê Dengan Supabase ¬∑ Data online, akses dari mana saja</p>
            </div>
        </div>
        
        <div class="main-content">
            <!-- SETUP SUPABASE -->
            <div class="setup-section" id="setupSection">
                <h3>üîå Koneksi ke Supabase</h3>
                <p>Masukkan URL dan Key dari project Supabase kamu:</p>
                <input type="text" id="supabaseUrl" placeholder="https://xyzabc.supabase.co" value="https://ntyetosvnafeuhnmljd.supabase.co">
                <input type="text" id="supabaseKey" placeholder="anon public key" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50eWV0b3N2bmFmZXVsaG5tamxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MDI1MTgsImV4cCI6MjA4NzA3ODUxOH0.GwsN9AR9rHS8CNDZuC80_gN52lSl_IUa2qixuUGFynU">
                <button onclick="connectSupabase()" class="btn-success">üîå CONNECT</button>
                <button onclick="createTable()" class="btn-success">üìã CREATE TABLE</button>
                <div id="connectionStatus"></div>
            </div>

            <div class="import-section">
                <h2 style="margin-bottom: 15px;">üìã IMPORT DATA CUSTOMER</h2>
                <div class="format-info">
                    <strong>Format (pisah dengan spasi):</strong><br>
                    NoHP Nama Produk Qty Harga Status DP<br>
                    <small>Contoh: 81399999999 danny sepatu-5073 1 159000 dapat 50000</small>
                </div>
                <textarea id="importData" placeholder="Tempel data disini..."></textarea>
                <button onclick="importToSupabase()" class="btn-success">‚ú® IMPORT KE DATABASE</button>
            </div>

            <h2 style="margin-bottom: 20px;">üì± DAFTAR CUSTOMER</h2>
            <div id="customersList" class="customers-grid"></div>
            
            <div class="warning">
                ‚ö†Ô∏è <strong>PENTING:</strong> Data tersimpan di cloud Supabase. Customer bisa buka link langsung dari HP!
            </div>
        </div>
    </div>

    <script>
        let supabase = null;
        let supabaseConnected = false;

        function showNotification(message, isError = false) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.style.background = isError ? '#dc3545' : '#28a745';
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        function connectSupabase() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                showNotification('Isi URL dan Key dulu!', true);
                return;
            }

            try {
                supabase = window.supabase.createClient(url, key);
                supabaseConnected = true;
                document.getElementById('connectionStatus').innerHTML = '<div class="status-connected">‚úÖ Terkoneksi ke Supabase!</div>';
                showNotification('‚úÖ Berhasil connect ke Supabase');
                loadCustomers();
            } catch (e) {
                showNotification('Gagal connect: ' + e.message, true);
            }
        }

        async function createTable() {
            if (!supabase) {
                showNotification('Connect dulu ke Supabase!', true);
                return;
            }

            try {
                // Coba buat table dengan insert dummy
                const { error } = await supabase
                    .from('customers')
                    .insert([{ 
                        phone: 'temp', 
                        name: 'temp', 
                        products: [], 
                        total_dp: 0 
                    }])
                    .select();
                
                if (error && error.message.includes('relation') && error.message.includes('does not exist')) {
                    showNotification('Tabel belum ada. Buat manual di Supabase SQL Editor!', true);
                    window.open('https://supabase.com/dashboard/project/ntyetosvnafeuhnmljd/sql', '_blank');
                } else {
                    showNotification('‚úÖ Tabel sudah siap!');
                }
            } catch (e) {
                showNotification('Error: ' + e.message, true);
            }
        }

        function generatePrivateLink(phone) {
            const baseUrl = window.location.origin;
            const token = btoa(phone + 'jastip2024').substring(0, 15);
            return `${baseUrl}/customer.html?id=${phone}&token=${token}`;
        }

        async function importToSupabase() {
            if (!supabase) {
                showNotification('Connect dulu ke Supabase!', true);
                return;
            }

            const text = document.getElementById('importData').value;
            if (!text) {
                showNotification('Masukkan data dulu!', true);
                return;
            }

            const lines = text.split('\n');
            let imported = 0;

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                const parts = line.split(/\s+/);
                if (parts.length < 6) continue;

                let noHp, nama, produk, qty, harga, status, dp = 0;
                
                if (parts.length >= 7) {
                    [noHp, nama, produk, qty, harga, status, dp] = parts;
                } else {
                    [noHp, nama, produk, qty, harga, status] = parts;
                }

                noHp = noHp.replace(/\D/g, '');
                
                // Cek apakah customer sudah ada
                const { data: existing } = await supabase
                    .from('customers')
                    .select('*')
                    .eq('phone', noHp)
                    .maybeSingle();

                const productData = {
                    nama: produk,
                    qty: parseInt(qty) || 0,
                    harga: parseInt(harga) || 0,
                    status: status,
                    dp: parseInt(dp) || 0
                };

                if (existing) {
                    // Update existing customer
                    const currentProducts = existing.products || [];
                    currentProducts.push(productData);
                    
                    await supabase
                        .from('customers')
                        .update({ 
                            products: currentProducts,
                            total_dp: (existing.total_dp || 0) + (parseInt(dp) || 0),
                            last_update: new Date().toLocaleString('id-ID')
                        })
                        .eq('phone', noHp);
                } else {
                    // Customer baru
                    await supabase
                        .from('customers')
                        .insert([{
                            phone: noHp,
                            name: nama,
                            products: [productData],
                            total_dp: parseInt(dp) || 0,
                            last_update: new Date().toLocaleString('id-ID'),
                            first_order: new Date().toISOString()
                        }]);
                }
                imported++;
            }

            showNotification(`‚úÖ Berhasil import ${imported} produk`);
            document.getElementById('importData').value = '';
            loadCustomers();
        }

        async function loadCustomers() {
            if (!supabase) return;

            const { data: customers, error } = await supabase
                .from('customers')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading:', error);
                return;
            }

            const container = document.getElementById('customersList');
            container.innerHTML = '';

            customers.forEach(customer => {
                let totalBelanja = 0;
                let totalItems = 0;
                
                customer.products.forEach(p => {
                    totalBelanja += p.qty * p.harga;
                    totalItems += p.qty;
                });

                const link = generatePrivateLink(customer.phone);
                const sisa = totalBelanja - (customer.total_dp || 0);
                
                const isNew = customer.first_order && 
                    (new Date() - new Date(customer.first_order)) < 24 * 60 * 60 * 1000;

                const card = document.createElement('div');
                card.className = 'customer-card';
                
                let badgeHtml = isNew ? '<span class="new-customer-badge">üÜï BARU</span>' : '';

                card.innerHTML = `
                    <div class="customer-header">
                        <span class="customer-name">${customer.name} ${badgeHtml}</span>
                        <span class="customer-phone">${customer.phone}</span>
                    </div>
                    <div class="private-link" id="link-${customer.phone}">${link}</div>
                    <button class="copy-btn" onclick="copyLink('${customer.phone}')">üìã COPY LINK</button>
                    <div class="stats">
                        <span>üì¶ ${totalItems} item</span>
                        <span>üí∞ Rp ${totalBelanja.toLocaleString()}</span>
                    </div>
                    <div class="stats">
                        <span>üíµ DP: Rp ${(customer.total_dp || 0).toLocaleString()}</span>
                        <span>üí≥ Sisa: Rp ${sisa.toLocaleString()}</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function copyLink(phone) {
            const linkElement = document.getElementById(`link-${phone}`);
            const link = linkElement.textContent;
            
            navigator.clipboard.writeText(link).then(() => {
                showNotification('‚úÖ Link disalin!');
            });
        }

        // Auto-connect dengan credential yang sudah diisi
        window.onload = function() {
            setTimeout(() => {
                connectSupabase();
            }, 500);
        };
    </script>
</body>
</html>
