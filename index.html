<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jastipbyceline ¬∑ Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            color: #333;
            font-size: 2.5rem;
        }
        .header p {
            color: #666;
            margin-top: 10px;
        }
        .backup-buttons {
            display: flex;
            gap: 10px;
        }
        .main-content {
            background: white;
            border-radius: 0 0 20px 20px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .import-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px dashed #dee2e6;
        }
        .format-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            margin: 15px 0;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-family: monospace;
            margin-bottom: 15px;
            resize: vertical;
        }
        textarea:focus {
            border-color: #667eea;
            outline: none;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .customers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .customer-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #dee2e6;
            position: relative;
        }
        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }
        .customer-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        .customer-phone {
            color: #667eea;
            font-weight: 600;
        }
        .new-customer-badge {
            background: #28a745;
            color: white;
            padding: 3px 10px;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 10px;
            text-transform: uppercase;
        }
        .private-link {
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            word-break: break-all;
            margin: 10px 0;
        }
        .copy-btn {
            background: #28a745;
            width: 100%;
            margin-top: 5px;
        }
        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            color: #666;
            font-size: 0.9rem;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            animation: slideIn 0.3s;
            z-index: 1000;
        }
        .notification.new-customer {
            background: #17a2b8;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .first-order-info {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        .existing-order-info {
            background: #e9ecef;
            border-left: 4px solid #6c757d;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        .backup-panel {
            background: #e3f2fd;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #90caf9;
        }
        .backup-panel h3 {
            color: #0d47a1;
            margin-bottom: 15px;
        }
        .file-input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üì¶ JASTIPBYCELINE ADMIN</h1>
                <p>üîê Private link system ¬∑ Link tetap untuk customer yang sama</p>
            </div>
            <div class="backup-buttons">
                <button class="btn-success" onclick="exportData()">üíæ EXPORT DATA</button>
                <button class="btn-warning" onclick="document.getElementById('fileInput').click()">üìÇ IMPORT JSON</button>
                <button class="btn-danger" onclick="clearAllData()">üóëÔ∏è CLEAR ALL</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="backup-panel">
                <h3>üìã BACKUP & RESTORE DATA</h3>
                <p style="margin-bottom: 15px;">Export data ke file JSON untuk dipindah ke device lain atau sebagai backup.</p>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn-success" onclick="exportData()">üíæ EXPORT DATA (JSON)</button>
                    <button class="btn-warning" onclick="document.getElementById('fileInput').click()">üìÇ RESTORE FROM JSON</button>
                    <span style="color: #666; margin-left: 10px;">Data tersimpan: <span id="dataCount">0</span> customer</span>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".json" onchange="importFromFile(event)">
            </div>

            <div class="import-section">
                <h2 style="margin-bottom: 15px;">üìã IMPORT DATA CUSTOMER (CSV/Text)</h2>
                <div class="format-info">
                    <strong>Format (pisah dengan spasi atau |):</strong><br>
                    NoHP Nama Produk Qty Harga Status DP<br>
                    <small>Contoh: 81399999999 danny celana 1 159000 dapat 50000</small>
                </div>
                <textarea id="importData" placeholder="Tempel data disini..."></textarea>
                <button onclick="importData()">‚ú® IMPORT DATA</button>
                <button class="btn-warning" onclick="clearImportField()">üóëÔ∏è Clear</button>
            </div>

            <h2 style="margin-bottom: 20px;">üì± DAFTAR CUSTOMER & LINK PRIVATE</h2>
            <div id="customersList" class="customers-grid"></div>
            
            <div class="warning">
                ‚ö†Ô∏è <strong>PENTING:</strong> 
                <ul style="margin-left: 20px; margin-top: 5px;">
                    <li>üü¢ <strong>Customer baru:</strong> Akan otomatis dibuatkan link baru</li>
                    <li>üîµ <strong>Customer lama:</strong> Link tetap sama, data terupdate</li>
                    <li>üíæ <strong>Backup data:</strong> Export JSON sebelum ganti browser/device</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let customers = JSON.parse(localStorage.getItem('jastip_customers')) || {};

        function updateDataCount() {
            document.getElementById('dataCount').innerText = Object.keys(customers).length;
        }

        function showNotification(message, isNew = false) {
            const notif = document.createElement('div');
            notif.className = `notification ${isNew ? 'new-customer' : ''}`;
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        function generatePrivateLink(phone) {
            const baseUrl = window.location.origin;
            const token = btoa(phone + 'jastip2024').substring(0, 15);
            return `${baseUrl}/customer.html?id=${phone}&token=${token}`;
        }

        function isNewCustomer(phone) {
            return !customers[phone];
        }

        function parseLine(line) {
            line = line.trim();
            if (!line) return null;

            let parts;
            if (line.includes('|')) {
                parts = line.split('|').map(p => p.trim());
            } else {
                parts = line.split(/\s+/);
            }

            if (parts.length < 6) return null;

            let noHp, nama, produk, qty, harga, status, dp = 0;
            
            if (parts.length >= 7) {
                [noHp, nama, produk, qty, harga, status, dp] = parts;
            } else {
                [noHp, nama, produk, qty, harga, status] = parts;
            }

            noHp = noHp.replace(/\D/g, '');
            
            return {
                noHp,
                nama,
                produk,
                qty: parseInt(qty) || 0,
                harga: parseInt(harga) || 0,
                status,
                dp: parseInt(dp) || 0
            };
        }

        function importData() {
            const text = document.getElementById('importData').value;
            if (!text) {
                showNotification('Masukkan data dulu!', false);
                return;
            }

            const lines = text.split('\n');
            let imported = 0;
            let newCustomers = {};
            let newCustomerPhones = [];
            let existingCustomerPhones = [];

            lines.forEach(line => {
                const data = parseLine(line);
                if (data) {
                    const isNew = isNewCustomer(data.noHp);
                    
                    if (!newCustomers[data.noHp]) {
                        newCustomers[data.noHp] = {
                            noHp: data.noHp,
                            nama: data.nama,
                            products: [],
                            totalDp: 0,
                            lastUpdate: new Date().toLocaleString('id-ID'),
                            firstOrder: isNew ? new Date().toISOString() : customers[data.noHp]?.firstOrder,
                            isNewCustomer: isNew
                        };
                        
                        if (isNew) {
                            newCustomerPhones.push(data.noHp);
                        } else {
                            existingCustomerPhones.push(data.noHp);
                        }
                    }
                    
                    newCustomers[data.noHp].products.push({
                        nama: data.produk,
                        qty: data.qty,
                        harga: data.harga,
                        status: data.status,
                        dp: data.dp
                    });
                    newCustomers[data.noHp].totalDp += data.dp;
                    imported++;
                }
            });

            Object.keys(newCustomers).forEach(phone => {
                if (customers[phone]) {
                    customers[phone].products = [
                        ...customers[phone].products,
                        ...newCustomers[phone].products
                    ];
                    customers[phone].totalDp += newCustomers[phone].totalDp;
                    customers[phone].lastUpdate = new Date().toLocaleString('id-ID');
                } else {
                    customers[phone] = newCustomers[phone];
                }
            });

            localStorage.setItem('jastip_customers', JSON.stringify(customers));
            
            if (newCustomerPhones.length > 0) {
                showNotification(`‚úÖ ${newCustomerPhones.length} CUSTOMER BARU dengan link baru!`, true);
            }
            if (existingCustomerPhones.length > 0) {
                showNotification(`üîÑ ${existingCustomerPhones.length} customer lama (link tetap)`, false);
            }
            
            document.getElementById('importData').value = '';
            renderCustomers();
            updateDataCount();
        }

        function exportData() {
            const dataStr = JSON.stringify(customers, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `jastip-backup-${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification(`‚úÖ Data ${Object.keys(customers).length} customer diexport!`);
        }

        function importFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    customers = importedData;
                    localStorage.setItem('jastip_customers', JSON.stringify(customers));
                    renderCustomers();
                    updateDataCount();
                    showNotification(`‚úÖ Berhasil import ${Object.keys(customers).length} customer dari file!`);
                } catch (error) {
                    showNotification('‚ùå File JSON tidak valid!', false);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        function clearAllData() {
            if (confirm('Hapus SEMUA data customer? Data tidak bisa dikembalikan!')) {
                customers = {};
                localStorage.removeItem('jastip_customers');
                renderCustomers();
                updateDataCount();
                showNotification('üóëÔ∏è Semua data dihapus!');
            }
        }

        function clearImportField() {
            document.getElementById('importData').value = '';
        }

        function renderCustomers() {
            const container = document.getElementById('customersList');
            container.innerHTML = '';

            const sortedCustomers = Object.values(customers).sort((a, b) => {
                return new Date(b.firstOrder || 0) - new Date(a.firstOrder || 0);
            });

            sortedCustomers.forEach(customer => {
                let totalBelanja = 0;
                let totalItems = 0;
                
                customer.products.forEach(p => {
                    totalBelanja += p.qty * p.harga;
                    totalItems += p.qty;
                });

                const link = generatePrivateLink(customer.noHp);
                const sisa = totalBelanja - customer.totalDp;
                
                const isNew = customer.firstOrder && 
                    (new Date() - new Date(customer.firstOrder)) < 24 * 60 * 60 * 1000;

                const card = document.createElement('div');
                card.className = 'customer-card';
                
                let badgeHtml = '';
                if (isNew) {
                    badgeHtml = '<span class="new-customer-badge">üÜï CUSTOMER BARU</span>';
                }
                
                let orderInfoHtml = '';
                if (isNew) {
                    orderInfoHtml = `
                        <div class="first-order-info">
                            üÜï <strong>First time order</strong> - Link baru dibuat otomatis
                        </div>
                    `;
                } else {
                    orderInfoHtml = `
                        <div class="existing-order-info">
                            üîÑ <strong>Repeat order</strong> - Link tetap sama, data terupdate
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="customer-header">
                        <span class="customer-name">${customer.nama} ${badgeHtml}</span>
                        <span class="customer-phone">${customer.noHp}</span>
                    </div>
                    <div class="private-link" id="link-${customer.noHp}">${link}</div>
                    <button class="copy-btn" onclick="copyLink('${customer.noHp}')">üìã COPY PRIVATE LINK</button>
                    ${orderInfoHtml}
                    <div class="stats">
                        <span>üì¶ ${totalItems} item</span>
                        <span>üí∞ Rp ${totalBelanja.toLocaleString()}</span>
                    </div>
                    <div class="stats" style="margin-top: 5px;">
                        <span>üíµ DP: Rp ${customer.totalDp.toLocaleString()}</span>
                        <span style="color: ${sisa > 0 ? '#dc3545' : '#28a745'}">üí≥ Sisa: Rp ${sisa.toLocaleString()}</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.8rem; color: #999;">
                        üïê Update: ${customer.lastUpdate}
                    </div>
                `;
                container.appendChild(card);
            });
            updateDataCount();
        }

        function copyLink(phone) {
            const linkElement = document.getElementById(`link-${phone}`);
            const link = linkElement.textContent;
            
            navigator.clipboard.writeText(link).then(() => {
                showNotification('‚úÖ Link private disalin!');
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = link;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('‚úÖ Link private disalin!');
            });
        }

        // Initial render
        renderCustomers();
        updateDataCount();
    </script>
</body>
</html>
