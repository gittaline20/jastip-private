<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jastipbyceline ¬∑ Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* [Saya singkat stylenya, tapi kamu bisa copy dari file sebelumnya] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; border-radius: 20px 20px 0 0; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .main-content { background: white; border-radius: 0 0 20px 20px; padding: 30px; }
        .import-section { background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 30px; border: 2px dashed #dee2e6; }
        .format-info { background: #e9ecef; padding: 15px; border-radius: 10px; font-family: monospace; margin: 15px 0; }
        textarea { width: 100%; height: 150px; padding: 15px; border: 2px solid #dee2e6; border-radius: 10px; font-family: monospace; margin-bottom: 15px; resize: vertical; }
        button { background: #28a745; color: white; border: none; padding: 12px 30px; border-radius: 50px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-right: 10px; }
        .customers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; margin-top: 30px; }
        .customer-card { background: #f8f9fa; border-radius: 15px; padding: 20px; border: 1px solid #dee2e6; }
        .private-link { background: #e9ecef; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 0.85rem; word-break: break-all; margin: 10px 0; }
        .copy-btn { background: #28a745; width: 100%; }
        .notification { position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 25px; border-radius: 50px; animation: slideIn 0.3s; z-index: 1000; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .status-connected { background: #d4edda; color: #155724; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì¶ JASTIPBYCELINE ADMIN</h1>
            <p>üîê Dengan Supabase ¬∑ Data online, akses dari mana saja</p>
        </div>
        
        <div class="main-content">
            <div id="connectionStatus" class="status-connected">
                ‚úÖ Terkoneksi ke Supabase!
            </div>

            <div class="import-section">
                <h2>üìã IMPORT DATA CUSTOMER</h2>
                <div class="format-info">
                    <strong>Format (pisah dengan spasi):</strong><br>
                    NoHP Nama Produk Qty Harga Status DP<br>
                    Contoh: 81365245060 danny5060 sepatu 1 159000 dapat 50000
                </div>
                <textarea id="importData" placeholder="Tempel data disini..."></textarea>
                <button onclick="importToSupabase()">‚ú® IMPORT KE DATABASE</button>
            </div>

            <h2>üì± DAFTAR CUSTOMER</h2>
            <div id="customersList" class="customers-grid"></div>
            
            <div style="margin-top: 20px; padding: 10px; background: #fff3cd; border-radius: 8px;">
                ‚ö†Ô∏è Data tersimpan di cloud Supabase. Customer bisa buka link langsung dari HP!
            </div>
        </div>
    </div>

    <script>
        // CONFIG - LANGSUNG DIISI
        const SUPABASE_URL = 'https://ntyetosvnafeuhnmljd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50eWV0b3N2bmFmZXVsaG5tamxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MDI1MTgsImV4cCI6MjA4NzA3ODUxOH0.GwsN9AR9rHS8CNDZuC80_gN52lSl_IUa2qixuUGFynU';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let supabaseConnected = true;

        function showNotification(message, isError = false) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.style.background = isError ? '#dc3545' : '#28a745';
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        function generatePrivateLink(phone) {
            const baseUrl = window.location.origin;
            const token = btoa(phone + 'jastip2024').substring(0, 15);
            return `${baseUrl}/customer.html?id=${phone}&token=${token}`;
        }

        async function importToSupabase() {
            const text = document.getElementById('importData').value;
            if (!text) {
                showNotification('Masukkan data dulu!', true);
                return;
            }

            const lines = text.split('\n');
            let imported = 0;

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                const parts = line.split(/\s+/);
                if (parts.length < 6) continue;

                let noHp, nama, produk, qty, harga, status, dp = 0;
                
                if (parts.length >= 7) {
                    [noHp, nama, produk, qty, harga, status, dp] = parts;
                } else {
                    [noHp, nama, produk, qty, harga, status] = parts;
                }

                noHp = noHp.replace(/\D/g, '');
                
                const { data: existing } = await supabase
                    .from('customers')
                    .select('*')
                    .eq('phone', noHp)
                    .maybeSingle();

                const productData = {
                    nama: produk,
                    qty: parseInt(qty) || 0,
                    harga: parseInt(harga) || 0,
                    status: status,
                    dp: parseInt(dp) || 0
                };

                if (existing) {
                    const currentProducts = existing.products || [];
                    currentProducts.push(productData);
                    
                    await supabase
                        .from('customers')
                        .update({ 
                            products: currentProducts,
                            total_dp: (existing.total_dp || 0) + (parseInt(dp) || 0),
                            last_update: new Date().toLocaleString('id-ID')
                        })
                        .eq('phone', noHp);
                } else {
                    await supabase
                        .from('customers')
                        .insert([{
                            phone: noHp,
                            name: nama,
                            products: [productData],
                            total_dp: parseInt(dp) || 0,
                            last_update: new Date().toLocaleString('id-ID'),
                            first_order: new Date().toISOString()
                        }]);
                }
                imported++;
            }

            showNotification(`‚úÖ Berhasil import ${imported} produk`);
            document.getElementById('importData').value = '';
            loadCustomers();
        }

        async function loadCustomers() {
            const { data: customers, error } = await supabase
                .from('customers')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error(error);
                return;
            }

            const container = document.getElementById('customersList');
            container.innerHTML = '';

            customers.forEach(customer => {
                let totalBelanja = 0;
                let totalItems = 0;
                
                customer.products.forEach(p => {
                    totalBelanja += p.qty * p.harga;
                    totalItems += p.qty;
                });

                const link = generatePrivateLink(customer.phone);
                const sisa = totalBelanja - (customer.total_dp || 0);

                const card = document.createElement('div');
                card.className = 'customer-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <strong>${customer.name}</strong>
                        <span>${customer.phone}</span>
                    </div>
                    <div class="private-link" id="link-${customer.phone}">${link}</div>
                    <button class="copy-btn" onclick="copyLink('${customer.phone}')">üìã COPY LINK</button>
                    <div style="margin-top: 10px;">
                        <div>üì¶ ${totalItems} item | üí∞ Rp ${totalBelanja.toLocaleString()}</div>
                        <div>üíµ DP: Rp ${(customer.total_dp || 0).toLocaleString()} | üí≥ Sisa: Rp ${sisa.toLocaleString()}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function copyLink(phone) {
            const linkElement = document.getElementById(`link-${phone}`);
            const link = linkElement.textContent;
            navigator.clipboard.writeText(link).then(() => {
                showNotification('‚úÖ Link disalin!');
            });
        }

        // Load data otomatis
        loadCustomers();
    </script>
</body>
</html>
